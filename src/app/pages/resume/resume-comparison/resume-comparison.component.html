<div class="grid">
  <div class="col-12">
    <p-card>
      <ng-template pTemplate="header">
        <div class="flex justify-content-between align-items-center p-4">
          <div>
            <h2 class="m-0">Resume Gap Analysis</h2>
            <p class="text-600 mt-1">Compare your resume against job requirements</p>
          </div>
          <div class="flex gap-2">
            <p-button 
              label="Export Report"
              icon="pi pi-download"
              (click)="exportAnalysisReport()"
              severity="secondary"
              size="small"
              [outlined]="true"
            ></p-button>
            <p-button 
              label="Back to Tailoring"
              icon="pi pi-arrow-left"
              (click)="goBack()"
              severity="secondary"
              size="small"
            ></p-button>
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="content">
        <div *ngIf="loading" class="flex justify-content-center p-4">
          <p-progressSpinner></p-progressSpinner>
        </div>

        <div *ngIf="!loading && gapAnalysis">
          <!-- Overall Score Summary -->
          <div class="score-summary-card mb-4 p-4 border-round">
            <div class="grid">
              <div class="col-12 md:col-3 text-center">
                <h3 class="mt-3 mb-0">Overall Match</h3>
                <p class="text-600 text-sm">{{ gapAnalysis.overallScore }}/100</p>
              </div>
              
              <div class="col-12 md:col-9">
                <div class="grid">
                  <div class="col-12 md:col-4">
                    <div class="metric-card p-3 border-round surface-card">
                      <div class="flex align-items-center gap-2 mb-2">
                        <i class="pi pi-code text-2xl text-primary"></i>
                        <span class="font-semibold">Skills Match</span>
                      </div>
                      <div class="text-3xl font-bold text-primary">
                        {{ gapAnalysis.skillsAnalysis.matchPercentage }}%
                      </div>
                      <p-progressBar 
                        [value]="gapAnalysis.skillsAnalysis.matchPercentage"
                        [showValue]="false"
                        styleClass="mt-2"
                      ></p-progressBar>
                      <small class="text-color-secondary">
                        {{ gapAnalysis.skillsAnalysis.matchedSkills.length }} of {{ gapAnalysis.skillsAnalysis.requiredSkills.length }} required
                      </small>
                    </div>
                  </div>
                  
                  <div class="col-12 md:col-4">
                    <div class="metric-card p-3 border-round surface-card">
                      <div class="flex align-items-center gap-2 mb-2">
                        <i class="pi pi-briefcase text-2xl" style="color: var(--green-500)"></i>
                        <span class="font-semibold">Bullet Quality</span>
                      </div>
                      <div class="text-3xl font-bold" style="color: var(--green-500)">
                        {{ gapAnalysis.experienceAnalysis.bulletQualityScore }}%
                      </div>
                      <p-progressBar 
                        [value]="gapAnalysis.experienceAnalysis.bulletQualityScore"
                        [showValue]="false"
                        styleClass="mt-2"
                      ></p-progressBar>
                      <small class="text-color-secondary">
                        {{ gapAnalysis.experienceAnalysis.totalBullets - gapAnalysis.experienceAnalysis.weakBullets.length }} strong bullets
                      </small>
                    </div>
                  </div>
                  
                  <div class="col-12 md:col-4">
                    <div class="metric-card p-3 border-round surface-card">
                      <div class="flex align-items-center gap-2 mb-2">
                        <i class="pi pi-search text-2xl" style="color: var(--purple-500)"></i>
                        <span class="font-semibold">ATS Score</span>
                      </div>
                      <div class="text-3xl font-bold" style="color: var(--purple-500)">
                        {{ gapAnalysis.atsScore.score }}%
                      </div>
                      <p-progressBar 
                        [value]="gapAnalysis.atsScore.score"
                        [showValue]="false"
                        styleClass="mt-2"
                      ></p-progressBar>
                      <small class="text-color-secondary">
                        Keyword optimization
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <p-divider></p-divider>

          <!-- View Mode Toggle -->
          <div class="flex justify-content-between align-items-center mb-4">
            <h3 class="m-0">Resume Comparison</h3>
            <p-selectButton 
              [options]="viewModeOptions" 
              [(ngModel)]="viewMode"
              optionLabel="label"
              optionValue="value"
              (onChange)="onViewModeChange()"
            >
              <ng-template let-item>
                <i [class]="item.icon + ' mr-2'"></i>
                <span>{{ item.label }}</span>
              </ng-template>
            </p-selectButton>
          </div>

          <!-- Side-by-Side View -->
          <div *ngIf="viewMode === 'side-by-side' && masterResume && tailoredResume">
            <p-splitter [style]="{ minHeight: '600px' }">
              <!-- Master Resume Panel -->
              <ng-template pTemplate>
                <div class="resume-panel p-4" style="overflow-y: auto;">
                  <div class="panel-header mb-4">
                    <h4 class="mb-2">
                      <i class="pi pi-file mr-2" style="color: var(--orange-500)"></i>
                      Your Master Resume
                    </h4>
                    <small class="text-color-secondary">Original comprehensive resume</small>
                  </div>

                  <!-- Skills Section -->
                  <div class="resume-section mb-4">
                    <h5 class="section-title">Skills ({{ getAllMasterSkills().length }})</h5>
                    <small class="text-color-secondary mb-2 block">
                      <i class="pi pi-info-circle mr-1"></i>
                      <span class="text-green-500"><i class="pi pi-check-circle"></i> Matched</span> | 
                      <span class="text-yellow-500"><i class="pi pi-exclamation-triangle"></i> Partial</span> | 
                      <span class="text-red-500"><i class="pi pi-times-circle"></i> Missing from Resume</span> | 
                      <span style="color: var(--text-color-secondary)">Not Required</span>
                    </small>
                    <div class="flex flex-wrap gap-2">
                      <p-tag 
                        *ngFor="let skill of getAllMasterSkills()"
                        [value]="skill.name"
                        [severity]="skill.status === 'matched' ? 'success' : (skill.status === 'partial' ? 'warning' : (skill.status === 'missing' ? 'danger' : undefined))"
                        [style]="skill.status === 'not-required' ? {'background-color': 'var(--surface-300)', 'color': 'var(--text-color)'} : {}"
                        styleClass="text-sm"
                      >
                        <i *ngIf="skill.status === 'matched'" class="pi pi-check-circle mr-1"></i>
                        <i *ngIf="skill.status === 'partial'" class="pi pi-exclamation-triangle mr-1"></i>
                        <i *ngIf="skill.status === 'missing'" class="pi pi-times-circle mr-1"></i>
                      </p-tag>
                    </div>
                  </div>

              <!-- Experience Section -->
              <div class="resume-section mb-4">
                <h5 class="section-title">Experience ({{ masterResume.experience.length }} jobs)</h5>
                 <div class="flex flex-column gap-2">
                   <p-selectButton 
                     [(ngModel)]="bulletViewMode" 
                     [options]="[{label: 'Original', value: 'original'}, {label: 'Optimized (STAR + ATS)', value: 'optimized'}]"
                     optionLabel="label"
                     optionValue="value"
                     (onChange)="toggleBulletView()"
                     size="small"
                     styleClass="custom-select-button"
                   ></p-selectButton>
                   <div *ngIf="optimizingBullets" class="optimization-container">
                     <p-progressBar 
                       [value]="optimizationProgress"
                       styleClass="optimization-progress"
                       [showValue]="false"
                     ></p-progressBar>
                     <small class="text-blue-500 font-semibold mt-1 block">
                       Optimizing {{ currentBulletIndex }} of {{ totalBullets }} bullets... ({{ optimizationProgress }}%)
                     </small>
                   </div>
                 </div>
                <small class="text-color-secondary mb-3 block mt-1">
                  <i class="pi pi-info-circle mr-1"></i>
                  Bullets ranked by job relevance (best matches first) | 
                  <span class="text-green-500">Strong</span> | 
                  <span class="text-orange-500">Needs Improvement</span>
                </small>
                <div *ngFor="let exp of masterResume.experience" class="experience-item mb-4 p-3 border-1 border-200 border-round">
                  <h6 class="mb-1">{{ exp.role }}</h6>
                  <p class="text-600 text-sm mb-2">{{ exp.company }}</p>
                  <ul class="pl-4">
                    <li *ngFor="let resp of getRankedResponsibilities(exp); let i = index" class="mb-3 text-sm" [class.weak-bullet]="isBulletWeak(resp.description)">
                      <div class="flex align-items-start gap-2">
                        <span class="ranking-badge">{{ i + 1 }}</span>
                        <i *ngIf="!isBulletWeak(resp.description)" class="pi pi-check-circle text-green-500 mt-1"></i>
                        <i *ngIf="isBulletWeak(resp.description)" class="pi pi-exclamation-triangle text-orange-500 mt-1"></i>
                        <span class="flex-1 bullet-display">
                          {{ getBulletDisplay(resp) }}
                        </span>
                      </div>
                      <div class="flex align-items-center gap-2 mt-1 ml-8">
                        <p-tag 
                          *ngIf="isBulletWeak(resp.description) && getBulletScore(resp.description) !== null"
                          [value]="'Quality: ' + getBulletScore(resp.description)"
                          severity="warning"
                          styleClass="text-xs"
                          [rounded]="true"
                        ></p-tag>
                        <p-tag 
                          *ngIf="getBulletRelevanceScore(resp.description) !== null"
                          [value]="'Relevance: ' + getBulletRelevanceScore(resp.description)"
                          severity="success"
                          styleClass="text-xs"
                          [rounded]="true"
                        ></p-tag>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
                </div>
              </ng-template>

              <!-- Optimized Resume Panel -->
              <ng-template pTemplate>
                <div class="resume-panel optimized p-4" style="overflow-y: auto;">
                  <div class="panel-header mb-4">
                    <h4 class="mb-2">
                      <i class="pi pi-star-fill mr-2" style="color: var(--green-500)"></i>
                      Optimized Resume
                    </h4>
                    <small class="text-color-secondary">Tailored for this job</small>
                  </div>

                  <!-- Skills Section -->
                  <div class="resume-section mb-4">
                    <h5 class="section-title">Skills ({{ tailoredResume.skills.length }})</h5>
                    <div class="flex flex-wrap gap-2">
                      <p-tag 
                        *ngFor="let skill of tailoredResume.skills"
                        [value]="skill.name"
                        severity="success"
                        styleClass="text-sm"
                      ></p-tag>
                    </div>
                  </div>

              <!-- Experience Section -->
              <div class="resume-section">
                <h5 class="section-title">Experience ({{ tailoredResume.experience.length }} jobs)</h5>
                <small class="text-color-secondary mb-3 block">
                  <i class="pi pi-info-circle mr-1"></i>
                  Ideal candidate experience for this job
                </small>
                <div *ngFor="let exp of tailoredResume.experience" class="experience-item mb-4 p-3 border-1 border-round" style="border-color: var(--green-500)">
                  <h6 class="mb-1">
                    <i class="pi pi-check-circle mr-1 text-green-500"></i>
                    {{ exp.role }}
                  </h6>
                  <p class="text-color-secondary text-sm mb-2">{{ exp.company }}</p>
                  <ul class="pl-4">
                    <li *ngFor="let resp of exp.responsibilities" class="mb-2 text-sm">
                      {{ resp.description }}
                      <span *ngIf="resp.tags && resp.tags.length > 0" class="text-color-secondary text-xs ml-2">
                        <i class="pi pi-tags mr-1"></i>{{ resp.tags.join(', ') }}
                      </span>
                    </li>
                  </ul>
                </div>
              </div>
                </div>
              </ng-template>
            </p-splitter>
          </div>

          <!-- Gaps Only View -->
          <div *ngIf="viewMode === 'gaps-only'">
            <p-card header="Skills Gap Analysis" styleClass="mb-4">
              <ng-template pTemplate="content">
                <div class="grid">
                  <!-- Matched Skills -->
                  <div class="col-12 md:col-4">
                    <h5 style="color: var(--green-500)">
                      <i class="pi pi-check-circle mr-2"></i>
                      Matched ({{ gapAnalysis.skillsAnalysis.matchedSkills.length }})
                    </h5>
                    <div class="flex flex-wrap gap-2">
                      <p-tag 
                        *ngFor="let skill of gapAnalysis.skillsAnalysis.matchedSkills"
                        [value]="skill.name"
                        severity="success"
                        [rounded]="true"
                      ></p-tag>
                    </div>
                  </div>

                  <!-- Partial Matches -->
                  <div class="col-12 md:col-4">
                    <h5 style="color: var(--yellow-500)">
                      <i class="pi pi-exclamation-triangle mr-2"></i>
                      Partial ({{ getPartialSkillsCount() }})
                    </h5>
                    <div class="flex flex-wrap gap-2">
                      <p-tag 
                        *ngFor="let skill of getPartialSkills()"
                        [value]="skill.name"
                        severity="warning"
                        [rounded]="true"
                      ></p-tag>
                    </div>
                    <small *ngIf="getPartialSkillsCount() > 0" class="text-color-secondary">
                      You have related skills but not exact matches
                    </small>
                  </div>

                  <!-- Missing Skills -->
                  <div class="col-12 md:col-4">
                    <h5 style="color: var(--red-500)">
                      <i class="pi pi-times-circle mr-2"></i>
                      Missing ({{ gapAnalysis.skillsAnalysis.missingSkills.length }})
                    </h5>
                    <div class="flex flex-wrap gap-2">
                      <p-tag 
                        *ngFor="let skill of gapAnalysis.skillsAnalysis.missingSkills"
                        [value]="skill.name"
                        severity="danger"
                        [rounded]="true"
                      ></p-tag>
                    </div>
                    <small *ngIf="gapAnalysis.skillsAnalysis.missingSkills.length > 0" class="text-color-secondary">
                      Critical gaps to address
                    </small>
                  </div>
                </div>
              </ng-template>
            </p-card>

            <!-- ATS Keyword Analysis -->
            <p-card header="ATS Keyword Optimization" styleClass="mb-4">
              <ng-template pTemplate="content">
                <div class="mb-3">
                  <h5>Keyword Density Analysis</h5>
                  <small class="text-600">Optimal density is 2-3 occurrences per keyword</small>
                </div>
                
                <div class="grid">
                  <div *ngFor="let kw of getTopKeywords()" class="col-12 md:col-6 lg:col-4">
                    <div class="keyword-item p-2 border-round surface-card border-1" [ngClass]="{
                      'border-green-500': kw.status === 'good',
                      'border-red-500': kw.status === 'low',
                      'border-yellow-500': kw.status === 'high'
                    }">
                      <div class="flex justify-content-between align-items-center">
                        <span class="font-medium">{{ kw.keyword }}</span>
                        <p-tag 
                          [value]="kw.count + 'x'"
                          [severity]="kw.status === 'good' ? 'success' : (kw.status === 'low' ? 'danger' : 'warning')"
                          [rounded]="true"
                        ></p-tag>
                      </div>
                      <small class="text-color-secondary">Optimal: {{ kw.optimal }}x</small>
                    </div>
                  </div>
                </div>

                <div *ngIf="gapAnalysis.atsScore.formattingIssues.length > 0" class="mt-4">
                  <h5 style="color: var(--orange-500)">Formatting Issues</h5>
                  <ul class="pl-4">
                    <li *ngFor="let issue of gapAnalysis.atsScore.formattingIssues" class="mb-1 text-color-secondary">
                      {{ issue }}
                    </li>
                  </ul>
                </div>
              </ng-template>
            </p-card>

            <!-- Weak Bullets -->
            <p-card header="Bullet Point Quality" *ngIf="gapAnalysis.experienceAnalysis.weakBullets.length > 0" styleClass="mb-4">
              <ng-template pTemplate="content">
                <p-accordion>
                  <p-accordionTab 
                    *ngFor="let bullet of getTopWeakBullets(); let i = index"
                    [header]="'Bullet #' + (i + 1) + ' - Score: ' + bullet.score + '/100'"
                  >
                    <div class="mb-3">
                      <strong>Current:</strong>
                      <p class="ml-3 text-600">{{ bullet.description }}</p>
                    </div>
                    
                    <div class="mb-3" *ngIf="bullet.issues.length > 0">
                      <strong style="color: var(--red-500)">Issues:</strong>
                      <ul class="ml-3 mt-1">
                        <li *ngFor="let issue of bullet.issues" style="color: var(--red-500)">{{ issue }}</li>
                      </ul>
                    </div>
                    
                    <div *ngIf="bullet.suggestions.length > 0">
                      <strong style="color: var(--green-500)">Suggestions:</strong>
                      <ul class="ml-3 mt-1">
                        <li *ngFor="let suggestion of bullet.suggestions" style="color: var(--green-500)">{{ suggestion }}</li>
                      </ul>
                    </div>
                  </p-accordionTab>
                </p-accordion>
              </ng-template>
            </p-card>
          </div>

          <p-divider></p-divider>

          <!-- Recommendations Section -->
          <div class="recommendations-section">
            <div class="flex justify-content-between align-items-center mb-3">
              <h3 class="m-0">Actionable Recommendations</h3>
              <p-tag 
                [value]="gapAnalysis.recommendations.length + ' items'"
                severity="info"
              ></p-tag>
            </div>

            <p-accordion [multiple]="true">
              <!-- Critical Recommendations -->
              <p-accordionTab 
                *ngIf="getCriticalRecommendations().length > 0"
                [header]="'Critical Issues (' + getCriticalRecommendations().length + ')'"
              >
                <div *ngFor="let rec of getCriticalRecommendations()" class="recommendation-item critical mb-3 p-3 border-2 border-round" style="border-color: var(--red-500)">
                  <div class="flex align-items-start gap-2">
                    <i class="pi pi-exclamation-circle text-xl mt-1" style="color: var(--red-500)"></i>
                    <div class="flex-1">
                      <h5 class="mt-0 mb-1" style="color: var(--red-500)">{{ rec.title }}</h5>
                      <p class="text-color-secondary text-sm mb-2">{{ rec.description }}</p>
                      <div class="action-item p-2 border-round">
                        <strong class="text-sm" style="color: var(--green-500)">Action:</strong>
                        <p class="m-0 mt-1 text-sm">{{ rec.actionable }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </p-accordionTab>

              <!-- High Priority Recommendations -->
              <p-accordionTab 
                *ngIf="getHighRecommendations().length > 0"
                [header]="'High Priority (' + getHighRecommendations().length + ')'"
              >
                <div *ngFor="let rec of getHighRecommendations()" class="recommendation-item high mb-3 p-3 border-2 border-round" style="border-color: var(--orange-500)">
                  <div class="flex align-items-start gap-2">
                    <i class="pi pi-exclamation-triangle text-xl mt-1" style="color: var(--orange-500)"></i>
                    <div class="flex-1">
                      <h5 class="mt-0 mb-1" style="color: var(--orange-500)">{{ rec.title }}</h5>
                      <p class="text-color-secondary text-sm mb-2">{{ rec.description }}</p>
                      <div class="action-item p-2 border-round">
                        <strong class="text-sm" style="color: var(--green-500)">Action:</strong>
                        <p class="m-0 mt-1 text-sm">{{ rec.actionable }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </p-accordionTab>

              <!-- Medium Priority Recommendations -->
              <p-accordionTab 
                *ngIf="getMediumRecommendations().length > 0"
                [header]="'Medium Priority (' + getMediumRecommendations().length + ')'"
              >
                <div *ngFor="let rec of getMediumRecommendations()" class="recommendation-item medium mb-3 p-3 border-2 border-round" style="border-color: var(--blue-500)">
                  <div class="flex align-items-start gap-2">
                    <i class="pi pi-info-circle text-xl mt-1" style="color: var(--blue-500)"></i>
                    <div class="flex-1">
                      <h5 class="mt-0 mb-1" style="color: var(--blue-500)">{{ rec.title }}</h5>
                      <p class="text-color-secondary text-sm mb-2">{{ rec.description }}</p>
                      <div class="action-item p-2 border-round">
                        <strong class="text-sm" style="color: var(--green-500)">Action:</strong>
                        <p class="m-0 mt-1 text-sm">{{ rec.actionable }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </p-accordionTab>

              <!-- Low Priority Recommendations -->
              <p-accordionTab 
                *ngIf="getLowRecommendations().length > 0"
                [header]="'Low Priority (' + getLowRecommendations().length + ')'"
              >
                <div *ngFor="let rec of getLowRecommendations()" class="recommendation-item low mb-3 p-3 border-2 border-round" style="border-color: var(--surface-border)">
                  <div class="flex align-items-start gap-2">
                    <i class="pi pi-info text-xl mt-1 text-color-secondary"></i>
                    <div class="flex-1">
                      <h5 class="mt-0 mb-1">{{ rec.title }}</h5>
                      <p class="text-color-secondary text-sm mb-2">{{ rec.description }}</p>
                      <div class="action-item p-2 border-round">
                        <strong class="text-sm" style="color: var(--green-500)">Action:</strong>
                        <p class="m-0 mt-1 text-sm">{{ rec.actionable }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </p-accordionTab>
            </p-accordion>
          </div>
        </div>
      </ng-template>
    </p-card>
  </div>
</div>

<p-toast></p-toast>

