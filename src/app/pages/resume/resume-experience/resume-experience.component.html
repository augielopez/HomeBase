<div class="grid">
  <div class="col-12">
    <p-card header="Work Experience" subheader="Manage your professional work history">
      <ng-template pTemplate="content">
        <div *ngIf="loading" class="flex justify-content-center p-4">
          <p-progressSpinner></p-progressSpinner>
        </div>

        <div *ngIf="!loading">
          <div class="flex justify-content-between align-items-center mb-4 gap-3">
            <h3 class="m-0">Work Experience ({{ experiences.length }})</h3>
            <p-button 
              label="Add New Experience"
              icon="pi pi-plus"
              (click)="openNewExperienceDialog()"
              severity="primary"
            ></p-button>
          </div>

          <div *ngIf="experiences.length === 0" class="text-center p-4">
            <i class="pi pi-briefcase text-4xl text-blue-500 mb-3"></i>
            <p class="text-lg text-600">No work experience added yet</p>
            <p class="text-600">Click "Add New Experience" to get started</p>
          </div>

          <div *ngIf="experiences.length > 0">
            <p-accordion>
              <p-accordionTab *ngFor="let experience of experiences" [header]="experience.role + ' at ' + experience.company">
                <ng-template pTemplate="header">
                  <div class="flex justify-content-between align-items-center w-full">
                    <div class="flex align-items-center gap-3">
                      <img 
                        *ngIf="experience.image_url" 
                        [src]="experience.image_url" 
                        [alt]="experience.company"
                        style="width: 75px; height: 75px; object-fit: contain; border-radius: 4px;"
                      />
                    <div>
                      <h4 class="m-0">{{ experience.role }}</h4>
                      <p class="m-0 text-600">{{ experience.company }}</p>
                      <small class="text-500">{{ formatDateRange(experience.start_date || '', experience.end_date || '') }}</small>
                      </div>
                    </div>
                    <p-buttongroup style="margin-top: 5px; margin-left: 10px;">
                      <p-button 
                        icon="pi pi-pencil"
                        size="small"
                        severity="secondary"
                        (click)="openEditExperienceDialog(experience)"
                        [outlined]="true"
                        pTooltip="Edit"
                        tooltipPosition="top"
                      ></p-button>
                      <p-button 
                        icon="pi pi-cog"
                        size="small"
                        severity="secondary"
                        (click)="openJobSettings(experience)"
                        [outlined]="true"
                        pTooltip="Settings"
                        tooltipPosition="top"
                      ></p-button>
                      <p-button 
                        icon="pi pi-trash"
                        size="small"
                        severity="danger"
                        (click)="confirmDelete(experience)"
                        [outlined]="true"
                        pTooltip="Delete"
                        tooltipPosition="top"
                      ></p-button>
                    </p-buttongroup>
                  </div>
                </ng-template>

                <div *ngIf="experience.responsibilities && experience.responsibilities.length > 0">
                  <div class="flex justify-content-between align-items-center mb-2">
                    <h5 class="m-0">Responsibilities & Achievements</h5>
                    <div class="flex align-items-center gap-2">
                      <p-inputTextarea 
                        [(ngModel)]="currentJobDescription" 
                        placeholder="Paste job description for optimization context"
                        rows="2"
                        styleClass="text-sm"
                        style="width: 200px;"
                      ></p-inputTextarea>
                      <p-selectButton 
                        [(ngModel)]="bulletViewMode" 
                        [options]="[{label: 'Original', value: 'original'}, {label: 'Optimized', value: 'optimized'}]"
                        optionLabel="label"
                        optionValue="value"
                        (onChange)="toggleBulletView()"
                        size="small"
                      ></p-selectButton>
                    </div>
                  </div>
                  <p-table 
                    [value]="experience.responsibilities" 
                    styleClass="p-datatable-sm p-datatable-striped"
                    [tableStyle]="{'min-width': '100%'}"
                  >
                    <ng-template pTemplate="header">
                      <tr>
                        <th style="width: 65%">Description</th>
                        <th style="width: 35%">Tags</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-resp>
                      <tr>
                        <td>
                          <div class="bullet-display" [class.optimized-bullet]="bulletViewMode === 'optimized'">
                            {{ getBulletDisplay(resp) }}
                          </div>
                        </td>
                        <td>
                        <div *ngIf="resp.tags && resp.tags.length > 0">
                          <p-chips 
                            [ngModel]="resp.tags" 
                            [disabled]="true"
                              styleClass="p-chips-sm"
                          ></p-chips>
                        </div>
                          <span *ngIf="!resp.tags || resp.tags.length === 0" class="text-400">No tags</span>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
                <div *ngIf="!experience.responsibilities || experience.responsibilities.length === 0" class="text-600">
                  No responsibilities added
                </div>

                <!-- Managers Section -->
                <div *ngIf="experience.managers && experience.managers.length > 0" class="mt-4">
                  <h5 class="mb-2">Managers</h5>
                  <p-table 
                    [value]="getSortedManagers(experience.managers)" 
                    styleClass="p-datatable-sm p-datatable-striped"
                    [tableStyle]="{'min-width': '100%'}"
                  >
                    <ng-template pTemplate="header">
                      <tr>
                        <th style="width: 40%">Manager Name</th>
                        <th style="width: 30%">Start Date</th>
                        <th style="width: 30%">End Date</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-manager>
                      <tr>
                        <td>{{ manager.manager_name }}</td>
                        <td>{{ manager.start_date || 'N/A' }}</td>
                        <td>{{ manager.end_date || 'Present' }}</td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              </p-accordionTab>
            </p-accordion>
          </div>
        </div>
      </ng-template>
    </p-card>
  </div>
</div>

<!-- Experience Dialog -->
<p-dialog 
  header="{{ editingExperience ? 'Edit Work Experience' : 'Add New Work Experience' }}"
  [(visible)]="showDialog"
  [modal]="true"
  [style]="{ width: '800px', height: '600px' }"
  [closable]="!saving"
>
  <form (ngSubmit)="saveExperience()" #expForm="ngForm">
    <div class="grid">
      <div class="col-12 md:col-6">
        <div class="field">
          <label for="role" class="font-medium">Job Title *</label>
          <input 
            pInputText 
            id="role"
            name="role"
            [(ngModel)]="experienceForm.role"
            #roleField="ngModel"
            required
            class="w-full"
            placeholder="Enter job title"
            [disabled]="saving"
          />
          <small *ngIf="roleField.invalid && roleField.touched" class="p-error">
            Job title is required
          </small>
        </div>
      </div>

      <div class="col-12 md:col-6">
        <div class="field">
          <label for="company" class="font-medium">Company *</label>
          <input 
            pInputText 
            id="company"
            name="company"
            [(ngModel)]="experienceForm.company"
            #companyField="ngModel"
            required
            class="w-full"
            placeholder="Enter company name"
            [disabled]="saving"
          />
          <small *ngIf="companyField.invalid && companyField.touched" class="p-error">
            Company name is required
          </small>
        </div>
      </div>

      <div class="col-12 md:col-6">
        <div class="field">
          <label for="startDate" class="font-medium">Start Date</label>
          <input 
            pInputText 
            type="date"
            id="startDate"
            name="startDate"
            [(ngModel)]="experienceForm.start_date"
            class="w-full"
            [disabled]="saving"
          />
        </div>
      </div>

      <div class="col-12 md:col-6">
        <div class="field">
          <label for="endDate" class="font-medium">End Date</label>
          <input 
            pInputText 
            type="date"
            id="endDate"
            name="endDate"
            [(ngModel)]="experienceForm.end_date"
            class="w-full"
            [disabled]="saving"
          />
          <small class="text-600">Leave empty if currently employed</small>
        </div>
      </div>

      <div class="col-12">
        <div class="field">
          <label for="imageSelect" class="font-medium mb-2">Experience Image</label>
          <small class="text-600 block mb-2">Select an image to display for this work experience</small>
          
          <p-dropdown
            id="imageSelect"
            [options]="availableImages"
            [(ngModel)]="experienceForm.image_url"
            name="image_url"
            placeholder="Select an image"
            [disabled]="saving"
            [showClear]="true"
            [appendTo]="'body'"
            class="w-full"
          >
            <ng-template pTemplate="selectedItem" let-option>
              <div class="flex align-items-center gap-2" *ngIf="option">
                <img *ngIf="option.value" [src]="option.value" [alt]="option.label" style="width: 30px; height: 30px; object-fit: contain;" />
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
            <ng-template pTemplate="item" let-option>
              <div class="flex align-items-center gap-2">
                <img *ngIf="option.value" [src]="option.value" [alt]="option.label" style="width: 30px; height: 30px; object-fit: contain;" />
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
          </p-dropdown>

          <div *ngIf="experienceForm.image_url" class="mt-3 border-1 border-200 border-round p-3">
            <span class="font-medium block mb-2">Image Preview</span>
            <img 
              [src]="experienceForm.image_url" 
              alt="Experience image preview" 
              style="max-width: 250px; max-height: 150px; object-fit: contain;"
            />
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="field">
          <div class="flex justify-content-between align-items-center mb-3">
            <label class="font-medium mt-2 mr-2">Responsibilities & Achievements</label>
            <p-button 
              *ngIf="experienceForm.responsibilities.length === 0"
              label="Add Responsibility"
              icon="pi pi-plus"
              size="small"
              (click)="addResponsibility()"
              [disabled]="saving"
              severity="primary"
            ></p-button>
          </div>
          
          <div *ngIf="experienceForm.responsibilities.length === 0" class="text-center p-4 border-1 border-dashed border-300 border-round">
            <i class="pi pi-info-circle text-2xl text-500 mb-2"></i>
            <p class="text-600 m-0">No responsibilities added yet</p>
            <p class="text-500 text-sm">Click "Add Responsibility" to get started</p>
          </div>

          <div *ngIf="experienceForm.responsibilities.length > 0" class="border-1 border-200 border-round overflow-hidden">
            <p-table 
              [value]="experienceForm.responsibilities" 
              styleClass="p-datatable-sm"
              [tableStyle]="{'min-width': '100%'}"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th style="width: 60%">Bullet Point / Description</th>
                  <th style="width: 35%">Tags</th>
                  <th style="width: 5%"></th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-resp let-i="rowIndex">
                <tr>
                  <td>
                    <textarea 
                      pInputTextarea 
                      [(ngModel)]="resp.description"
                      name="resp{{ i }}"
                      rows="2"
                      class="w-full"
                      placeholder="Describe your responsibility or achievement..."
                      [disabled]="saving"
                      [autoResize]="true"
                    ></textarea>
                  </td>
                  <td>
                    <p-autoComplete 
                      name="respTags{{ i }}"
                      [(ngModel)]="resp.tags"
                      [suggestions]="filteredTags"
                      (completeMethod)="filterTags($event)"
                      (onSelect)="onTagSelect($event, i)"
                      (onUnselect)="onTagSelect($event, i)"
                      placeholder="Type to search or add tags"
                      [multiple]="true"
                      [disabled]="saving"
                      [dropdown]="true"
                      [appendTo]="'body'"
                      styleClass="w-full"
                    ></p-autoComplete>
                  </td>
                  <td class="text-center">
              <p-button 
                icon="pi pi-trash"
                size="small"
                severity="danger"
                (click)="removeResponsibility(i)"
                [disabled]="saving"
                [text]="true"
                      [rounded]="true"
                      pTooltip="Delete"
                    ></p-button>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>

          <!-- Add Responsibility Button at Bottom -->
          <div *ngIf="experienceForm.responsibilities.length > 0" class="flex justify-content-center mt-3">
            <p-button 
              label="Add Another Responsibility"
              icon="pi pi-plus"
              (click)="addResponsibility()"
              [disabled]="saving"
              severity="secondary"
            ></p-button>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="field">
          <div class="flex justify-content-between align-items-center mb-3">
            <label class="font-medium mt-2 mr-2">Managers</label>
            <p-button 
              *ngIf="experienceForm.managers.length === 0"
              label="Add Manager"
              icon="pi pi-plus"
              size="small"
              (click)="addManager()"
              [disabled]="saving"
              severity="primary"
              ></p-button>
            </div>
            
          <div *ngIf="experienceForm.managers.length === 0" class="text-center p-4 border-1 border-dashed border-300 border-round">
            <i class="pi pi-info-circle text-2xl text-500 mb-2"></i>
            <p class="text-600 m-0">No managers added yet</p>
            <p class="text-500 text-sm">Click "Add Manager" to track your managers for this position</p>
            </div>
            
          <div *ngIf="experienceForm.managers.length > 0" class="border-1 border-200 border-round overflow-hidden">
            <p-table 
              [value]="experienceForm.managers" 
              dataKey="manager_name"
              styleClass="p-datatable-sm p-datatable-striped"
              [tableStyle]="{'min-width': '100%'}"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th style="width: 30%">Manager Name</th>
                  <th style="width: 25%">Start Date</th>
                  <th style="width: 25%">End Date</th>
                  <th style="width: 20%">Actions</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-manager let-rowIndex="rowIndex">
                <tr>
                  <td>
                    <input 
                      pInputText 
                      [(ngModel)]="manager.manager_name"
                      [name]="'manager_name_' + rowIndex"
                      placeholder="Manager's name"
                      class="w-full"
                      [disabled]="saving"
                    />
                  </td>
                  <td>
                    <input 
                      pInputText 
                      type="date"
                      [(ngModel)]="manager.start_date"
                      [name]="'manager_start_' + rowIndex"
                      class="w-full"
                      [disabled]="saving"
                    />
                  </td>
                  <td>
                    <input 
                      pInputText 
                      type="date"
                      [(ngModel)]="manager.end_date"
                      [name]="'manager_end_' + rowIndex"
                class="w-full"
                      [disabled]="saving"
                    />
                  </td>
                  <td>
                    <p-button 
                      icon="pi pi-trash"
                      [rounded]="true"
                      [text]="true"
                      severity="danger"
                      size="small"
                      (click)="removeManager(rowIndex)"
                      [disabled]="saving"
                    ></p-button>
                  </td>
                </tr>
              </ng-template>
            </p-table>

            <div class="p-3 border-top-1 border-200">
              <p-button 
                label="Add Another Manager"
                icon="pi pi-plus"
                (click)="addManager()"
                [disabled]="saving"
                severity="secondary"
              ></p-button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button 
        label="Cancel"
        icon="pi pi-times"
        (click)="cancelEdit()"
        [disabled]="saving"
        severity="secondary"
        [text]="true"
      ></p-button>
      <p-button 
        label="{{ editingExperience ? 'Update' : 'Add' }}"
        icon="pi pi-check"
        (click)="saveExperience()"
        [disabled]="!experienceForm.role?.trim() || !experienceForm.company?.trim() || saving"
        [loading]="saving"
        severity="primary"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Job Settings Dialog -->
<p-dialog 
  [(visible)]="showJobSettingsDialog" 
  [header]="selectedJobForSettings?.role + ' at ' + selectedJobForSettings?.company + ' - Job Settings'"
  [modal]="true" 
  [closable]="true"
  [style]="{width: '70vw'}"
  [draggable]="false"
  [resizable]="false"
>
  <div *ngIf="selectedJobForSettings" class="p-fluid">
    <!-- Date Adjustment Checkbox (only shown if job is NOT excluded) -->
    <div *ngIf="!isJobExcluded" class="mb-4">
      <div class="flex align-items-center">
        <p-checkbox 
          [(ngModel)]="adjustDates" 
          [binary]="true"
          inputId="adjustDates"
        ></p-checkbox>
        <label for="adjustDates" class="ml-2 cursor-pointer">
          Adjust start and end dates
        </label>
      </div>
      <small class="text-600 ml-4">
        Modify the dates shown on generated resumes (e.g., to prevent overlapping employment). Original dates remain unchanged.
      </small>
      
      <!-- Date Inputs (shown when adjustDates is checked) -->
      <div *ngIf="adjustDates" class="grid mt-3 ml-4">
        <div class="col-12 md:col-6">
          <label for="adjustedStartDate" class="block mb-2">Adjusted Start Date</label>
          <input 
            pInputText 
            type="date"
            id="adjustedStartDate"
            [(ngModel)]="adjustedStartDate"
            class="w-full"
          />
          <small class="text-500">Original: {{ selectedJobForSettings.start_date || 'N/A' }}</small>
        </div>
        <div class="col-12 md:col-6">
          <label for="adjustedEndDate" class="block mb-2">Adjusted End Date</label>
          <input 
            pInputText 
            type="date"
            id="adjustedEndDate"
            [(ngModel)]="adjustedEndDate"
            class="w-full"
          />
          <small class="text-500">Original: {{ selectedJobForSettings.end_date || 'Present' }}</small>
        </div>
      </div>
    </div>

    <!-- Display Tags Checkbox (only shown if job is NOT excluded) -->
    <div *ngIf="!isJobExcluded" class="mb-4">
      <div class="flex align-items-center">
        <p-checkbox 
          [(ngModel)]="displayTagsInResume" 
          [binary]="true"
          inputId="displayTags"
        ></p-checkbox>
        <label for="displayTags" class="ml-2 cursor-pointer">
          Display tags in resume
        </label>
      </div>
      <small class="text-600 ml-4">
        When enabled, responsibility tags will be shown in parentheses after each bullet point in generated resumes (e.g., "Developed applications (Angular, TypeScript, REST API)").
      </small>
    </div>

    <!-- Exclusion Checkbox -->
    <div class="mb-4">
      <div class="flex align-items-center">
        <p-checkbox 
          [(ngModel)]="isJobExcluded" 
          [binary]="true"
          inputId="excludeJob"
        ></p-checkbox>
        <label for="excludeJob" class="ml-2 cursor-pointer">
          Exclude this job from resume generation
        </label>
      </div>
      <small class="text-600 ml-4">
        When excluded, this job won't appear on generated resumes, but you can reassign its responsibilities to other jobs.
      </small>
    </div>

    <!-- Responsibility Mapping Table (only shown if job is excluded) -->
    <div *ngIf="isJobExcluded && selectedJobForSettings.responsibilities && selectedJobForSettings.responsibilities.length > 0">
      <p-divider></p-divider>
      
      <div class="flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">Responsibility Reassignments</h5>
        <p-button 
          label="Auto-Distribute" 
          icon="pi pi-bolt"
          (click)="autoDistributeMappings()"
          severity="info"
          size="small"
          [outlined]="true"
        ></p-button>
      </div>
      
      <p-table 
        [value]="selectedJobForSettings.responsibilities"
        styleClass="p-datatable-sm p-datatable-striped"
        [tableStyle]="{'min-width': '100%'}"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 60%">Responsibility</th>
            <th style="width: 40%">Assign To Job</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-resp let-rowIndex="rowIndex">
          <tr>
            <td>
              <div class="text-sm">{{ resp.description }}</div>
              <div *ngIf="resp.tags && resp.tags.length > 0" class="mt-1">
                <p-tag 
                  *ngFor="let tag of resp.tags" 
                  [value]="tag" 
                  severity="info"
                  styleClass="mr-1 text-xs"
                ></p-tag>
              </div>
            </td>
            <td>
              <p-dropdown 
                [ngModel]="getMappingForResponsibility(resp.id!)"
                [options]="availableTargetJobs"
                optionLabel="displayLabel"
                optionValue="id"
                placeholder="Select job"
                [appendTo]="'body'"
                [style]="{'width': '100%'}"
                (onChange)="onMappingChange(resp.id!, $event.value)"
              ></p-dropdown>
            </td>
          </tr>
        </ng-template>
      </p-table>
      
      <div *ngIf="!selectedJobForSettings.responsibilities || selectedJobForSettings.responsibilities.length === 0" class="text-center p-4 text-600">
        This job has no responsibilities to reassign.
      </div>
    </div>

    <div *ngIf="isJobExcluded && (!selectedJobForSettings.responsibilities || selectedJobForSettings.responsibilities.length === 0)" class="mt-3">
      <p-message severity="info" text="This job has no responsibilities to reassign."></p-message>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button 
        label="Cancel"
        icon="pi pi-times"
        (click)="closeJobSettings()"
        severity="secondary"
        [text]="true"
      ></p-button>
      <p-button 
        label="Save Settings"
        icon="pi pi-check"
        (click)="saveJobSettings()"
        [loading]="savingSettings"
        severity="primary"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
