<div class="bank-reconciliation-container">
    <div class="card">
        <!-- Header Section -->
        <div class="header-section">
            <div class="header-left">
                <h1>Bank Reconciliation</h1>
            </div>
            <div class="header-right">
                <div class="month-selector">
                    <p-dropdown 
                        [options]="monthOptions" 
                        [(ngModel)]="selectedMonth"
                        (onChange)="onMonthChange()"
                        placeholder="Select Month"
                        optionLabel="label"
                        optionValue="value"
                        [style]="{'width': '200px'}"
                        appendTo="body">
                    </p-dropdown>
                    <div class="flex items-center">
                        <p-button 
                            [label]="autoMatchingInProgress ? 'Processing...' : 'Auto Recon'" 
                            [icon]="autoMatchingInProgress ? 'pi pi-spin pi-spinner' : 'pi pi-bolt'"
                            severity="secondary"
                            [outlined]="true"
                            [disabled]="!selectedMonth || autoMatchingInProgress"
                            (onClick)="startAutoReconciliation()"
                            styleClass="ml-3">
                        </p-button>
                        
                        <p-button 
                            *ngIf="autoMatchingInProgress"
                            label="Cancel" 
                            icon="pi pi-times"
                            severity="danger"
                            [outlined]="true"
                            (onClick)="cancelAutoReconciliation()"
                            styleClass="ml-2">
                        </p-button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <div class="summary-row">
                <div class="currently-reconciling">
                    <span class="label">Currently Reconciling</span>
                    <p-dropdown 
                        [options]="accountOptions" 
                        [(ngModel)]="selectedAccount"
                        placeholder="Select Account"
                        optionLabel="name"
                        optionValue="id"
                        [style]="{'width': '250px'}"
                        appendTo="body"
                        (onChange)="onAccountChange()">
                    </p-dropdown>
                </div>
                
                <div class="financial-overview">
                    <div class="metric">
                        <div class="metric-label">Total Spent</div>
                        <div class="metric-value">{{ totalSpent | currency:'USD':'symbol':'1.2-2' }}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Total Income</div>
                        <div class="metric-value">{{ totalIncome | currency:'USD':'symbol':'1.2-2' }}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Net Amount</div>
                        <div class="metric-value" [class.text-red-600]="netAmount < 0" [class.text-green-600]="netAmount > 0">{{ netAmount | currency:'USD':'symbol':'1.2-2' }}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Transactions</div>
                        <div class="metric-value">{{ totalTransactions }}</div>
                    </div>
                </div>
            </div>

            <div class="selection-summary">
                <div class="selection-box">
                    <div class="selection-amount">{{ selectedTransactionAmount }}</div>
                    <div class="selection-label">{{ selectedTransactionDescription }}</div>
                </div>
                
                <div class="mark-as-button">
                        <p-button 
                            label="Match" 
                            icon="pi pi-arrows-h" 
                            [raised]="true" 
                            [disabled]="!selectedTransaction || !selectedBill"
                            (click)="onMatchTransaction()">
                        </p-button>
                </div>
                
                <div class="selection-box">
                    <div class="selection-amount">{{ selectedBillAmount }}</div>
                    <div class="selection-label">{{ selectedBillDescription }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reconciliation Tabs -->
    <p-tabs [value]="activeTabValue">
        <p-tablist>
            <p-tab value="0">Unmatched</p-tab>
            <p-tab value="1">Matched</p-tab>
        </p-tablist>
        <p-tabpanels>
            <p-tabpanel value="0">
                <!-- Main Content Area -->
                <div class="main-content">
                    <!-- Left Panel: Unreconciled Transactions -->
                    <div class="panel unreconciled-transactions">
                        <div class="panel-header">
                            <h3 class="panel-title-with-badge">                                         
                                <span>Unreconciled Transactions</span>
                                <p-badge [value]="unreconciledCount" />
                            </h3>
                        </div>
                        
                        <div class="search-container">
                            <p-inputgroup>
                                <input pInputText 
                                       placeholder="Search Transactions" 
                                       [(ngModel)]="transactionSearchTerm" />
                                <p-inputgroup-addon>
                                    <p-button icon="pi pi-search" severity="secondary" variant="text" />
                                </p-inputgroup-addon>
                            </p-inputgroup>
                        </div>
                        
                        <div class="transaction-list">
                            <div *ngIf="loadingTransactions" class="loading-message">
                                Loading transactions...
                            </div>
                            <div *ngFor="let transaction of filteredTransactions" 
                                 class="transaction-item" 
                                 [class.selected]="isTransactionSelected(transaction)"
                                 (click)="onTransactionSelect(transaction)">
                                <div class="transaction-checkbox">
                                    <input type="radio" 
                                           name="selectedTransaction" 
                                           [checked]="isTransactionSelected(transaction)"
                                           (click)="onTransactionSelect(transaction)">
                                </div>
                                <div class="transaction-content">
                                    <div class="transaction-date">{{ transaction.date }}</div>
                                    <div class="transaction-description" 
                                         [class.refund]="transaction.isRefund">{{ transaction.description }}</div>
                                    <div *ngIf="transaction.subtext" class="transaction-subtext">{{ transaction.subtext }}</div>
                                </div>
                                <div class="transaction-amount"
                                     [class.positive]="transaction.type === 'positive'"
                                     [class.negative]="transaction.type === 'negative'">{{ transaction.amount }}</div>
                            </div>
                        </div>
                        
                        <!-- Transaction Pagination -->
                        <div *ngIf="!loadingTransactions && totalFilteredTransactions > itemsPerPage" class="pagination-container">
                            <p-paginator 
                                [rows]="itemsPerPage" 
                                [totalRecords]="totalFilteredTransactions"
                                [first]="(currentTransactionPage - 1) * itemsPerPage"
                                (onPageChange)="onTransactionPageChange($event)"
                                [showCurrentPageReport]="true"
                                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} transactions">
                            </p-paginator>
                        </div>
                    </div>

                    <!-- Right Panel: Bills -->
                    <div class="panel bills">
                        <div class="panel-header">
                        <h3 class="panel-title-with-badge">
                            <span>Bills</span>
                            <p-badge [value]="billsCount" />
                        </h3>
                        </div>
                        
                        <div class="search-container">
                            <p-inputgroup>
                                <input pInputText 
                                       placeholder="Search Bills" 
                                       [(ngModel)]="billSearchTerm" />
                                <p-inputgroup-addon>
                                    <p-button icon="pi pi-search" severity="secondary" variant="text" />
                                </p-inputgroup-addon>
                            </p-inputgroup>
                        </div>
                        
                        <div class="bill-list">
                            <div *ngIf="loadingBills" class="loading-message">
                                Loading bills...
                            </div>
                            <div *ngFor="let bill of filteredBills" 
                                 class="bill-item" 
                                 [class.selected]="isBillSelected(bill)"
                                 (click)="onBillSelect(bill)">
                                <div class="bill-checkbox">
                                    <input type="radio" 
                                           name="selectedBill" 
                                           [checked]="isBillSelected(bill)"
                                           (click)="onBillSelect(bill)">
                                </div>
                                <div class="bill-content">
                                    <div class="bill-date">{{ bill.date }}</div>
                                    <div class="bill-merchant">{{ bill.merchant }}</div>
                                    <div class="bill-category">
                                        <i [class]="bill.category.icon + ' category-icon'"></i>
                                        <span>{{ bill.category.name }}</span>
                                    </div>
                                </div>
                                <div class="bill-amount">{{ bill.amount }}</div>
                            </div>
                        </div>
                        
                        <!-- Bill Pagination -->
                        <div *ngIf="!loadingBills && totalFilteredBills > itemsPerPage" class="pagination-container">
                            <p-paginator 
                                [rows]="itemsPerPage" 
                                [totalRecords]="totalFilteredBills"
                                [first]="(currentBillPage - 1) * itemsPerPage"
                                (onPageChange)="onBillPageChange($event)"
                                [showCurrentPageReport]="true"
                                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} bills">
                            </p-paginator>
                        </div>
                    </div>
                </div>
            </p-tabpanel>
            
            <p-tabpanel value="1">
                <div class="matched-content">
                    <div class="flex justify-between items-center mb-4">
                        <div class="panel-header">
                        <h3 class="panel-title-with-badge">
                            <span>All Matches</span>
                            <p-badge [value]="matchedCount" />
                        </h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <p-inputgroup>
                                <input pInputText placeholder="Search" />
                                <p-inputgroup-addon>
                                    <p-button icon="pi pi-search" severity="secondary" variant="text" />
                                </p-inputgroup-addon>
                            </p-inputgroup>
                            <p-button icon="pi pi-filter" severity="secondary" variant="text" />
                        </div>
                    </div>
                    
                    <p-table [value]="matchedTransactions" 
                             [loading]="loadingMatched"
                             [tableStyle]="{'min-width': '75rem'}" 
                             responsiveLayout="scroll">
                   <ng-template #header>
                       <tr>
                           <th style="width: 8rem">Date</th>
                           <th style="width: 20rem">Transaction</th>
                           <th style="width: 8rem">Transaction Amount</th>
                           <th style="width: 20rem">Bill Name</th>
                           <th style="width: 8rem">Bill Amount</th>
                       </tr>
                   </ng-template>
                        <ng-template #body let-matched>
                            <tr>
                                <td>{{ matched.transactionDate }}</td>
                                <td>{{ matched.transactionDescription }}</td>
                                <td>{{ matched.transactionAmount }}</td>
                                <td>
                                    <div class="flex flex-col">
                                        <span>{{ matched.billName }}</span>
                                        <span class="text-sm text-gray-500">{{ matched.billCategory }}</span>
                                    </div>
                                </td>
                                <td>{{ matched.billAmount }}</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>
</div>

<!-- Auto Reconciliation Confirmation Dialog -->
<p-dialog 
    header="Confirm Auto Reconciliation" 
    [(visible)]="showConfirmDialog" 
    [modal]="true" 
    [style]="{ width: '500px' }"
    [closable]="false"
    appendTo="body">
    
    <div class="confirmation-content">
        <div class="mb-4">
            <i class="pi pi-question-circle text-blue-500 text-3xl mb-3"></i>
            <p class="text-lg mb-2">Start Auto Reconciliation?</p>
            <p class="text-sm text-gray-600">
                This will automatically analyze and suggest matches for unreconciled transactions 
                in <strong>{{ selectedMonth | date:'MMMM yyyy' }}</strong> using AI-powered pattern matching.
            </p>
        </div>
        
        <div class="confirmation-actions flex justify-end gap-3">
            <p-button 
                label="Cancel" 
                severity="secondary"
                [outlined]="true"
                (onClick)="showConfirmDialog = false">
            </p-button>
            <p-button 
                label="Start Auto Recon" 
                icon="pi pi-bolt"
                (onClick)="confirmAutoReconciliation()">
            </p-button>
        </div>
    </div>
</p-dialog>

<!-- Auto Reconciliation Approval Dialog -->
<p-dialog 
    header="Auto Reconciliation Matches" 
    [(visible)]="showAutoMatchDialog" 
    [modal]="true" 
    [style]="{ width: '800px' }"
    [closable]="false"
    appendTo="body">
    
    <div class="auto-match-dialog">
        <div class="match-summary mb-4">
            <p>Found <strong>{{ suggestedMatches.length }}</strong> potential matches above {{ matchingConfig.confidenceThreshold }}% confidence threshold.</p>
            <p class="text-sm text-gray-600">Review and approve the matches below:</p>
        </div>
        
        <div class="match-list" style="max-height: 400px; overflow-y: auto;">
            <div *ngFor="let match of suggestedMatches" class="match-item p-3 border border-gray-200 rounded-lg mb-3">
                <div class="flex justify-between items-start">
                    <div class="match-details flex-1">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium">{{ match.transactionDescription }}</h4>
                            <p-tag 
                                [value]="match.confidence + '%'" 
                                [severity]="getConfidenceSeverity(match.confidence)">
                            </p-tag>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <strong>Match with:</strong> {{ match.billName }}
                        </div>
                        <div class="text-sm text-gray-500">
                            <strong>Reason:</strong> {{ match.reason }}
                            <span *ngIf="match.amountMatch" class="ml-2 text-green-600">• Amount matches</span>
                        </div>
                    </div>
                    <div class="match-actions ml-4">
                        <p-checkbox 
                            [binary]="true" 
                            [(ngModel)]="match.approved"
                            [style]="{'width': '20px', 'height': '20px'}">
                        </p-checkbox>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="dialog-actions mt-4 flex justify-between items-center">
            <div class="selection-info">
                <span *ngIf="getApprovedMatches().length > 0" class="text-sm text-blue-600">
                    {{ getApprovedMatches().length }} of {{ suggestedMatches.length }} matches selected
                </span>
            </div>
            <div class="action-buttons">
                <p-button 
                    label="Select All" 
                    size="small"
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="selectAllMatches(true)"
                    class="mr-2">
                </p-button>
                <p-button 
                    label="Select None" 
                    size="small"
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="selectAllMatches(false)"
                    class="mr-2">
                </p-button>
                <p-button 
                    label="Cancel" 
                    (onClick)="cancelAutoReconciliation()"
                    [outlined]="true"
                    class="mr-2">
                </p-button>
                <p-button 
                    label="Apply Selected Matches" 
                    [disabled]="getApprovedMatches().length === 0"
                    [loading]="applyingMatches"
                    (onClick)="applySelectedMatches()">
                </p-button>
            </div>
        </div>
    </div>
</p-dialog>
